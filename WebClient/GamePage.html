<!DOCTYPE html>
<html>
<head>
    <title>Voting Game</title>
</head>
<body>
    <div id="MainPage">
          <input id="StartGame" type="button" value="Press To Start The Game" /><br>
         <label id="status"></label>
    </div>
    <div id="tableContainer" style="height: 90%"></div><br><br>
   <!-- <label id="test"></label>-->
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">
    <!--Reference the jQuery library. -->
    <link href="StyleGame.css" rel="stylesheet" />
    <script src="Scripts/jquery-2.1.0.min.js"></script>
    <script src="Scripts/jquery-ui-1.10.4.min.js"></script>
    <!--Reference the SignalR library. -->
    <script src="Scripts/jquery.signalR-2.0.2.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="http://localhost:8010/signalr/hubs"></script>
    <script>
        function progressBarFunc() {
            $('#secbar').progressbar({ value: '101.667' });
            $('#secbar').show();
            //  $('#secs').css('display', 'block').text("60");
            var sec = 61;
            var val = 101.667;
            barInterval = setInterval(function () {
                val = val - 1.667;
                sec--;
                $('#secbar').progressbar({
                    value: val,
                    change: function () {
                        $('#secs').css('display', 'block').text(sec);
                    },
                    complete: function () { }
                });
                if (sec == 0) {
                    $('#' + defaultVote).trigger('click');
                }

            }, 1000);
        };
    </script>
    <script>
        var barInterval;
        var numOfImages;
        var numOfPlayers = 0;
        var playerIndex;
        var defaultVote = 0;
        var imageClick = false;
        var main;
        var votesProgressInterval = 0;
        var showWhoVoted = false;
        $(function () {
            //Set the hubs URL for the connection
            $.connection.hub.url = "http://localhost:8010/signalr";

            // Declare a proxy to reference the hub.
            main = $.connection.serverHub;

            main.client.startGameMsg = function (msg) {
                if (msg == "wait")
                    $('#status').text("Please wait for the other players, the game will start shortly...");
                else if (msg == "start") {
                    $("#MainPage").hide();
                    main.server.gameDetailsMsg($.connection.hub.id);
                    //window.open("/GamePage.html", "_self", false);
                        $('#turnStatus').text('Please wait for your turn');
                }
            };
            
            main.client.gameDetails = function (msg, playerI, numOfCandidates, numPlayers, numVotes, numTurns, priority, candNames, candIndex, defaultCand, point, votes, isVoted, voted, playerString, turn, voting, winner, turnsWait) {
                //$('playerTurn').val(turn);
                votesProgressInterval = 190 / numPlayers;
                numOfPlayers = numPlayers;
                numOfImages = numOfCandidates;
                playerIndex = playerI;
                showWhoVoted = isVoted;

                //create table
                $(function () {
                    //first table
                    var table1 = $('<table border="0" width="100%" style="height:50%"></table>');
                    row11 = $('<tr border="0" width="100%" style="height:100%"></tr>');
                    if (showWhoVoted == true) {
                        cell11 = $('<td width="20%" align="left" valign="top" style="height:100%"></td>').html('<label style="font-family:Arial"> There are ' + numPlayers + ' players, you are ' + playerString +'</label> <br/> <br/> <label id="turnsLeft" style="font-family:Arial"> Game ends in: ' + numTurns + ' turns</label>');
                    }
                    else {
                        cell11 = $('<td width="20%" align="left" valign="top" style="height:100%"></td>').html('<label style="font-family:Arial"> There are ' + numPlayers + ' players</label> <br/> <br/> <label id="turnsLeft" style="font-family:Arial"> Game ends in: ' + numTurns + ' turns</label>');
                    }

                    cell12 = $('<td width="60%" align="center" style="height:100%"></td>').html('<label id="turnStatus" style="font-family:Arial" ></label><br><br><label id="voteStatus" style="font-family:Arial font:bold" ></label><img id="waitImg" src="/images/wait.gif" style="height:15%"><br><br><label id="turnsToWait" style="font-family:Arial"></label><label id="playerVoted" style="font-family:Arial"></label><label id="gameOverTxt" style="font-family:Arial"></label><br><br><div id="secbar"><div id="secs"></div></div>');
                    cell13 = $('<td width="20%" align="left" valign="top" style="height:100%"></td>').html('<label></label>');
                    table1.append(row11);
                    row11.append(cell11);
                    row11.append(cell12);
                    row11.append(cell13);
                    $('#tableContainer').append(table1);

                    //second table
                    var table2 = $('<table width="100%" style="height:50%; table-layout: fixed; border:none" ></table>');
                    row21 = $('<tr width="100%" style="height:10%"></tr>'); //priority
                    row22 = $('<tr width="100%" style="height:10%"></tr>'); //points
                    row23 = $('<tr width="100%" style="height:60%"></tr>'); //pic
                    row24 = $('<tr width="100%" style="height:10%"></tr>'); //name
                    row25 = $('<tr width="100%" style="height:10%"></tr>'); //voted by
                    var cellWidth = 100 / numOfCandidates;
                    var points = point.split('#');
                    var priorities = priority.split('#');
                    var numOfVotes = votes.split('#');
                    var names = candNames.split('#');
                    var candIndexes = candIndex.split('#');
                    var whoVoted = voted.split("#");
  
                    for (var j = 0; j < 5; j++) { //for each row
                        if (j == 0) {
                            for (var i = 0; i < numOfCandidates; i++) {
                                cell21 = $('<td width=cellWidth + "%" align="center" style="height:10%"></td>').html('<label style="font-family:Arial">' + priorities[i] + '</label>');
                                row21.append(cell21);
                            }
                        }
                        else if (j == 1) {
                            for (var i = 0; i < numOfCandidates; i++) {
                                cell22 = $('<td width=cellWidth + "%" align="center" style="height:10%"></td>').html('<label style="font-family:Arial">' + points[i + 1] + ' points</label> <br><br>');
                                row22.append(cell22);
                            }
                        }
                        else if (j == 2) {
                            var pcellWidth = cellWidth * 0.5;
                            var icellWidth = cellWidth * 0.5;
                            for (var i = 0; i < numOfCandidates; i++) {
                                //if (i == 0)
                                //    var url = "/images/user" + (candIndexes[i + 1]) + "_default.png";
                                //else
                                    var url = "/images/user" + (candIndexes[i + 1]) + ".png";
                                var size = 80 - (8 * i);
                                //cell23 = $('<td class="imgCells" width=cellWidth + "%" align="center" style="height:60%"></td>').
                                //    html('<div class="progress"><label class="progNum" id="num' + i + '">' + numOfVotes[i + 1] + '</label><br /><div class="outer"> <div class="inner" id="inner'+i+'"></div></div></div> <img class="images" id="' + i + '" src="' + url + '" style="height:' + size + '%">');
                                
                                cell23 = $('<td class="imgCells" align="center" style="height:60%; width:cellWidth + %"></td>');
                                imgTable = $('<table width="100%" align="center" style="height:100%;"></table>');
                                imgrow = $('<tr width=100% style="height:100%"></tr>');
                                imgCell1 = $('<td width="25%" style="height:100%" align="right"></td>');
                                imgCell2 = $('<td width="75%" style="height:100%;" align="left" valign="middle"></td>').html('<img class="images" id="' + i + '" src="' + url + '" style=" margin-top:20px; height:' + size + '%">');
                                pTable = $('<table class="progBars" id="progBars'+i+'" width="30%" style="height:93%"></table><label class="numVoteslabel" id="progNum' + i + '"></label>');
                                var pheight = 100 / numPlayers;
                                for (var k = 0; k < numPlayers; k++) {
                                    prow = $('<tr width="100%" style="height:' + pheight + '%"></tr>');
                                    pcell = ('<td id="pcell' + i + k + '" width="100%" align="center" style="border: none;"><label class="progLabel" id="plabel' + i + k + '" style="margin-right:0px"></label></td>');
                                    prow.append(pcell);
                                    pTable.append(prow);
                                }
                                imgCell1.append(pTable);
                                imgrow.append(imgCell1);
                                imgrow.append(imgCell2);
                                imgTable.append(imgrow);

                                cell23.append(imgTable);
                                row23.append(cell23);
                            }
                        }
                        else if (j == 3) {
                            for (var i = 0; i < numOfCandidates; i++) {
                                cell24 = $('<td width=cellWidth + "%" align="center" style="height:10%"></td>').html('<label style="font-family:Arial; font-style:italic; font-weight: bold">' + names[i + 1] + '</label>');
                                row24.append(cell24);
                            }
                        }
                        else if (showWhoVoted == true && j == 4) {
                            //for (var i = 0; i < numOfCandidates; i++) {
                            //    cell25 = $('<td width=cellWidth + "%" align="center" style="height:10%"></td>').html('<label id=voted' + i + ' style="font-family:Arial">Who voted: ' + whoVoted[i + 1] + '</label>');
                            //    row25.append(cell25);
                            //}

                        }
                    }
                    table2.append(row21);
                    table2.append(row22);
                    table2.append(row23);
                    table2.append(row24);
                    table2.append(row25);

                    $('#tableContainer').append(table2);

                    var winners = winner.split("#");

                    for (var i = 0; i < numOfCandidates; i++) {
                        var cVoted = whoVoted[i+1].split(',');
                        var glow = 0;
                        for (var j = 1; j < winners.length; j++) {
                            if (winners[j] == i)
                                glow = 1;
                        }

                        for (var j = numOfPlayers - 1, k = 0; j >= (numOfPlayers - numOfVotes[i + 1]), k < cVoted.length; j--, k++) {
                            if (cVoted[k] != "") {
                                if (glow == 1) {
                                    $('#progBars' + i).css('border-color', '#808080');
                                    $('#progBars' + i).css('box-shadow', '0 0 10px #808080');
                                }
                                else {
                                    $('#progBars' + i).css('border-color', '#C0C0C0');
                                    $('#progBars' + i).css('box-shadow', 'none');
                                }
                                if (playerString == cVoted[k])
                                    $('#pcell' + i + j).css('background-image', "url('/images/progressBar2green.png')");
                                else
                                    $('#pcell' + i + j).css('background-image', "url('/images/progressBar2p2.png')");

                                if (showWhoVoted == true)
                                    $('#plabel' + i + j).text(cVoted[k]);
                            }
                            else {
                                $('#progBars' + i).css('border-color', '#C0C0C0');
                                $('#progBars' + i).css('box-shadow', 'none');
                            }
                        }

                        if (numOfVotes[i + 1] < 10) {
                            $('#progNum' + i).text(numOfVotes[i + 1]);
                            $('#progNum' + i).css('margin-right','10px');
                        }
                            
                        else if (numOfVotes[i + 1] < 100) {
                            $('#progNum' + i).text(numOfVotes[i + 1]);
                            $('#progNum' + i).css('margin-right', '8px');
                        }
                       
                    }

                    if (turn == 1) {
                        imageClick = true;
                        $('#waitImg').hide();
                        //$('#playerVoted').text('');
                        $('#turnsToWait').text('');
                        $('#turnStatus').text("It's your turn");
                        $('#voteStatus').text('VOTE NOW!');
                        progressBarFunc();
                    }
                    else {
                        imageClick = false;
                        $('#turnStatus').text('Please wait for player ' + (voting + 1) + ' to vote');
                        $('#turnsToWait').text('Your turn is in ' + turnsWait + ' steps');
                        $('#voteStatus').text('');
                        $('#waitImg').show();
                    }
                });
            }; //details function

            main.client.yourTurn = function () {
                imageClick = true;
                $('#waitImg').hide();
                //$('#playerVoted').text('');
                $('#turnsToWait').text('');
                $('#turnStatus').text("It's your turn");
                $('#voteStatus').text('VOTE NOW!');
                $(".images").fadeTo("fast", 1);
                progressBarFunc();
            };

            main.client.votedUpdate = function (numOfCandidates, votes, votesL, turnsL, candIndex, defaultCand, playerV, voting, winner, whoVoted, playerString, turnsWait) {
                defaultVote = defaultCand;
                $('#turnsToWait').text('Your turn is in ' + turnsWait + ' steps');
                //$('#playerVoted').text('player ' + (playerV + 1) + ' voted');
                $('#turnStatus').text('Please wait for player ' + (voting+1) + ' to vote');
                //$('#votesLeft').text('Remaining votes: ' + votesL);
                $('#turnsLeft').text('Game ends in: ' + turnsL + ' turns');
                var numOfVotes = votes.split("#");
                var winners = winner.split("#");
                var whoVotedString = whoVoted.split("#");
                //if (showWhoVoted == true) {
                    
                //    for (var i = 0; i < numOfCandidates; i++) {
                //        $('#voted' + i).text('Who voted: ' + whoVotedString[i + 1]);
                //    }
                //}

                for (var i = 0; i < numOfCandidates; i++) {
                    for (var j = 0; j < numOfPlayers; j++) {
                        $('#pcell' + i + j).css('background-image', 'none');
                        $('#plabel' + i + j).text("");
                    }
                }

                for (var i = 0; i < numOfCandidates; i++) {
                    var cVoted = whoVotedString[i + 1].split(',');
                    var glow = 0;
                    for (var j = 1; j < winners.length; j++) {
                        if (winners[j] == i)
                            glow = 1;
                    }

                    for (var j = numOfPlayers - 1, k = 0; j >= (numOfPlayers - numOfVotes[i + 1]), k < cVoted.length; j--, k++) {
                        if (cVoted[k] != "") {
                            if (glow == 1) {
                                $('#progBars' + i).css('border-color', '#808080');
                                $('#progBars' + i).css('box-shadow', '0 0 10px #808080');
                            }
                            else {
                                $('#progBars' + i).css('border-color', '#C0C0C0');
                                $('#progBars' + i).css('box-shadow', 'none');
                            }
                            if (playerString == cVoted[k])
                                $('#pcell' + i + j).css('background-image', "url('/images/progressBar2green.png')");
                            else
                                $('#pcell' + i + j).css('background-image', "url('/images/progressBar2p2.png')");

                            if (showWhoVoted == true)
                                $('#plabel' + i + j).text(cVoted[k]);
                        }
                        else {
                            $('#progBars' + i).css('border-color', '#C0C0C0');
                            $('#progBars' + i).css('box-shadow', 'none');
                        }
                    }

                    if (numOfVotes[i + 1] < 10) {
                        $('#progNum' + i).text(numOfVotes[i + 1]);
                        $('#progNum' + i).css('margin-right', '10px');
                    }

                    else if (numOfVotes[i + 1] < 100) {
                        $('#progNum' + i).text(numOfVotes[i + 1]);
                        $('#progNum' + i).css('margin-right', '8px');
                    }
                }

                var candIndexes = candIndex.split('#');
                //for (var i = 0; i < numOfCandidates; i++) {
                //    if (i == defaultCand) {
                //        var url = "/images/user" + (candIndexes[i + 1]) + "_default.png";
                //        $('#' + i).attr('src', url);
                //    } else {
                //        var url = "/images/user" + (candIndexes[i + 1]) + ".png";
                //        $('#' + i).attr('src', url);
                //    }
                //}
            };

            main.client.otherVotedUpdate = function (numOfCandidates, votes, votesL, turnsL, playerV, voting, winner, whoVoted, playerString, turnswait) {
                $('#turnStatus').text('Please wait for player ' + (voting+1) + ' to vote');
                //$('#votesLeft').text('Remaining votes: ' + votesL);
                $('#turnsLeft').text('Game ends in: ' + turnsL + ' turns');
                var numOfVotes = votes.split("#");
                var winners = winner.split("#");
                var whoVotedString = whoVoted.split("#");


                //if (showWhoVoted == true) {
                    
                //    for (var i = 0; i < numOfCandidates; i++) {
                //        $('#voted' + i).text('Who voted: ' + whoVotedString[i + 1]);
                //    }
                //}

                for (var i = 0; i < numOfCandidates; i++) {
                    for (var j = 0; j < numOfPlayers; j++) {
                        $('#pcell' + i + j).css('background-image', 'none');
                        $('#plabel' + i + j).text("");
                    }
                }

                for (var i = 0; i < numOfCandidates; i++) {
                    var cVoted = whoVotedString[i + 1].split(',');
                    var glow = 0;
                    for (var j = 1; j < winners.length; j++) {
                        if (winners[j] == i)
                            glow = 1;
                    }

                    for (var j = numOfPlayers - 1, k = 0; j >= (numOfPlayers - numOfVotes[i + 1]), k < cVoted.length; j--, k++) {
                        if (cVoted[k] != "") {
                            if (glow == 1) {
                                $('#progBars' + i).css('border-color', '#808080');
                                $('#progBars' + i).css('box-shadow', '0 0 10px #808080');
                            }
                            else {
                                $('#progBars' + i).css('border-color', '#C0C0C0');
                                $('#progBars' + i).css('box-shadow', 'none');
                            }
                            if (playerString == cVoted[k])
                                $('#pcell' + i + j).css('background-image', "url('/images/progressBar2green.png')");
                            else
                                $('#pcell' + i + j).css('background-image', "url('/images/progressBar2p2.png')");

                            if (showWhoVoted == true)
                                $('#plabel' + i + j).text(cVoted[k]);
                        }
                        else {
                            $('#progBars' + i).css('border-color', '#C0C0C0');
                            $('#progBars' + i).css('box-shadow', 'none');
                        }
                    }
                    if (numOfVotes[i + 1] < 10) {
                        $('#progNum' + i).text(numOfVotes[i + 1]);
                        $('#progNum' + i).css('margin-right', '10px');
                    }

                    else if (numOfVotes[i + 1] < 100) {
                        $('#progNum' + i).text(numOfVotes[i + 1]);
                        $('#progNum' + i).css('margin-right', '8px');
                    }
                }
                $('#turnsToWait').text('Your turn is in ' + turnswait + ' steps');
                //$('#playerVoted').text('player ' + (playerV+1) + ' voted');

            };

            main.client.gameOver = function (numOfCandidates, votes, votesL, turnsL, points, winner, currentWinner, whoVoted, playerString) {

                imageClick = false;
                //$('#votesLeft').text('Remaining votes: ' + votesL);
                $('#turnsLeft').text('Game ends in: ' + turnsL + ' turns');
                var numOfVotes = votes.split("#");
                var winners = currentWinner.split("#");
                var whoVotedString = whoVoted.split("#");
                //if (showWhoVoted == true) {
                   
                //    for (var i = 0; i < numOfCandidates; i++) {
                //        $('#voted' + i).text('Who voted: ' + whoVotedString[i + 1]);
                //    }
                //}

                for (var i = 0; i < numOfCandidates; i++) {
                    for (var j = 0; j < numOfPlayers; j++) {
                        $('#pcell' + i + j).css('background-image', 'none');
                        $('#plabel' + i + j).text("");
                    }
                }

                for (var i = 0; i < numOfCandidates; i++) {
                    var cVoted = whoVotedString[i + 1].split(',');
                    var glow = 0;
                    for (var j = 1; j < winners.length; j++) {
                        if (winners[j] == i)
                            glow = 1;
                    }

                    for (var j = numOfPlayers - 1, k = 0; j >= (numOfPlayers - numOfVotes[i + 1]), k < cVoted.length; j--, k++) {
                        if (cVoted[k] != "") {
                            if (glow == 1) {
                                $('#progBars' + i).css('border-color', '#808080');
                                $('#progBars' + i).css('box-shadow', '0 0 10px #C0C0C0');
                            }
                            else {
                                $('#progBars' + i).css('border-color', '#C0C0C0');
                                $('#progBars' + i).css('box-shadow', 'none');
                            }
                            if (playerString == cVoted[k])
                                $('#pcell' + i + j).css('background-image', "url('/images/progressBar2green.png')");
                            else
                                $('#pcell' + i + j).css('background-image', "url('/images/progressBar2p2.png')");

                            if (showWhoVoted == true)
                                $('#plabel' + i + j).text(cVoted[k]);
                        }
                        else {
                            $('#progBars' + i).css('border-color', '#C0C0C0');
                            $('#progBars' + i).css('box-shadow', 'none');
                        }
                    }

                    if (numOfVotes[i + 1] < 10) {
                        $('#progNum' + i).text(numOfVotes[i + 1]);
                        $('#progNum' + i).css('margin-right', '10px');
                    }

                    else if (numOfVotes[i + 1] < 100) {
                        $('#progNum' + i).text(numOfVotes[i + 1]);
                        $('#progNum' + i).css('margin-right', '8px');
                    }
                }

                var pPoints = points.split('#');
                $('#waitImg').hide();
                $('#turnsToWait').text('');
                //$('#playerVoted').text('');
                $('#turnStatus').text('GAME OVER!!!');
                if (winner.indexOf(',')>=0)
                    $('#gameOverTxt').html('The winning candidates are: <i><b>' + winner + '</b></i><br/> Your score is: ' + pPoints[playerIndex + 1]);
                else
                    $('#gameOverTxt').html('The winning candidate is: <i><b>' + winner + '</b></i><br/> Your score is: ' + pPoints[playerIndex + 1]);

            };
            
            $.connection.hub.start().done(function () {
                $('#StartGame').click(function () {
                    // Call the Send method on the hub.
                    main.server.connectMsg('connect', $.connection.hub.id);
                });
            });
        });
        
        $(document).on('click', '.images', function (event) {
            if (imageClick) {
                $(".images:not(#" + event.target.id + ")").fadeTo("fast", 0.5);
                $("#" + event.target.id).fadeTo("fast", 1);

                clearInterval(barInterval);
                $('#secbar').hide();
                $('#turnStatus').text('Please wait for your turn');
                $('#waitImg').show();
                //$('#test').text('');
                $('#voteStatus').text('');
                imageClick = false;

                main.server.voteDetails($.connection.hub.id, playerIndex, event.target.id);
            }
        });

       
        
    </script>
</body>
</html>


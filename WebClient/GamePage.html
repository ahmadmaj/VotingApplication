<!DOCTYPE html>
<html>
<head>
    <title>Voting Game</title>
    <style type="text/css">
        html, body {
            height: 100%;
        }

        label {
            font-family: Arial;
        }

        #secbar {
            width: 50%;
            height: 10%;
            /*position: absolute;
            right: 50%;*/
        }

            #secbar .ui-progressbar-value {
                background-image: url('/images/progressBar.png');
            }

        #secs {
            display: none;
            float: left;
            margin-top: 5px;
            font-weight: bold;
            font-size: 70%;
            /*text-shadow: 1px 1px 0 #808080;*/
            /*text-align: center;
            align-content: center;
            align-items: center;
            align-self: center;*/
            position: absolute;
            left: 49%;
        }
    </style>
</head>
<body>
    
    <div id="tableContainer" style="height: 90%"></div><br><br>
    <label id="test"></label>
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">
    <!--Reference the jQuery library. -->
    <script src="Scripts/jquery-2.1.0.min.js"></script>
    <script src="Scripts/jquery-ui-1.10.4.min.js"></script>
    <!--Reference the SignalR library. -->
    <script src="Scripts/jquery.signalR-2.0.2.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="http://localhost:8080/signalr/hubs"></script>
    <script>
        function progressBarFunc() {
            $('#secbar').progressbar({ value: '101.667' });
            $('#secbar').show();
            //  $('#secs').css('display', 'block').text("60");
            var sec = 61;
            var val = 101.667;
            barInterval = setInterval(function () {
                val = val - 1.667;
                sec--;
                $('#secbar').progressbar({
                    value: val,
                    change: function () {
                        $('#secs').css('display', 'block').text(sec);
                    },
                    complete: function () { }
                });
                if (sec == 0) {
                    $('#' + defaultVote).trigger('click');     
                }

            }, 1000);
        };
    </script>
    <script>
        var barInterval;
        var numOfImages;
        var playerIndex;
        var defaultVote = 0;
        var imageClick = false;
        $(document).ready(function () {
            //var playerTurn = 0;
            
            //connect to the server hub
            $.connection.hub.url = "http://localhost:8080/signalr";
            var main = $.connection.serverHub;

            $.connection.hub.start().done(function () {
                main.server.gameDetailsMsg($.connection.hub.id);
                $(document).on('click', '.images', function (event) {
                    if (imageClick) {
                        $(".images:not(#" + event.target.id + ")").fadeTo("fast", 0.5);
                        $("#" + event.target.id).fadeTo("fast", 1);

                        clearInterval(barInterval);
                        $('#secbar').hide();
                        $('#turnStatus').text('Please wait for your turn');
                        $('#waitImg').show();
                        $('#voteStatus').text('');
                        imageClick = false;

                        main.server.voteDetails($.connection.hub.id, playerIndex, event.target.id);
                    }

                });
            });

            main.client.gameDetails = function (msg, playerI, numOfCandidates, numPlayers, numVotes, numTurns, priority, candNames, candIndex, defaultCand, point, voted, turn) {
                //$('playerTurn').val(turn);
                numOfImages = numOfCandidates;
                playerIndex = playerI;
                //create table
                $(function () {
                    //first table
                    var table1 = $('<table border="0" width="100%" style="height:50%"></table>');
                    row11 = $('<tr border="0" width="100%" style="height:100%"></tr>');
                    cell11 = $('<td width="20%" align="left" valign="top" style="height:100%"></td>').html('<label style="font-family:Arial">You are player ' + (playerIndex + 1) + ' (out of ' + numPlayers + ')</label>');
                    cell12 = $('<td width="60%" align="center" style="height:100%"></td>').html('<label id="turnStatus" style="font-family:Arial" ></label><br><br><label id="voteStatus" style="font-family:Arial font:bold" ></label><img id="waitImg" src="/images/wait.gif" style="height:15%"><label id="gameOverTxt" style="font-family:Arial" ></label><br><br><div id="secbar"><div id="secs"></div></div>');
                    cell13 = $('<td width="20%" align="left" valign="top" style="height:100%"></td>').html('<label id="votesLeft" style="font-family:Arial">Remaining votes: ' + numVotes + '</label> <br/> <label id="turnsLeft" style="font-family:Arial"> Game terminates in: ' + numTurns + ' turns</label>');
                    table1.append(row11);
                    row11.append(cell11);
                    row11.append(cell12);
                    row11.append(cell13);
                    $('#tableContainer').append(table1);

                    //second table
                    var table2 = $('<table border="0" width="100%" style="height:50%" ></table>');
                    row21 = $('<tr border="0" width="100%" style="height:10%"></tr>'); //priority
                    row22 = $('<tr border="0" width="100%" style="height:10%"></tr>'); //points
                    row23 = $('<tr border="0" width="100%" style="height:60%"></tr>'); //pic
                    row24 = $('<tr border="0" width="100%" style="height:10%"></tr>'); //name
                    row25 = $('<tr border="0" width="100%" style="height:10%"></tr>'); //voted by
                    var cellWidth = 100 / numOfCandidates;
                    var points = point.split('#');
                    var priorities = priority.split('#');
                    var votedBy = voted.split('#');
                    var names = candNames.split('#');
                    var candIndexes = candIndex.split('#');
                    for (var j = 0; j < 5; j++) { //for each row
                        if (j == 0) {
                            for (var i = 0; i < numOfCandidates; i++) {
                                cell21 = $('<td width=cellWidth + "%" align="center" style="height:10%"></td>').html('<label style="font-family:Arial">' + priorities[i] + '</label>');
                                row21.append(cell21);
                            }
                        }
                        else if (j == 1) {
                            for (var i = 0; i < numOfCandidates; i++) {
                                cell22 = $('<td width=cellWidth + "%" align="center" style="height:10%"></td>').html('<label style="font-family:Arial">' + points[i + 1] + '</label>');
                                row22.append(cell22);
                            }
                        }
                        else if (j == 2) {
                            for (var i = 0; i < numOfCandidates; i++) {
                                if(i==0)
                                    var url = "/images/user" + (candIndexes[i + 1]) + "_default.png";
                                else
                                    var url = "/images/user" + (candIndexes[i + 1]) + ".png";
                                var size = 100 - (10 * i);
                                cell23 = $('<td class="imgCells" width=cellWidth + "%" align="center" style="height:60%"></td>').html('<img class="images" id="' + i + '" src="' + url + '" style="height:'+size+'%">');
                                row23.append(cell23);
                            }
                        }
                        else if (j == 3) {
                            for (var i = 0; i < numOfCandidates; i++) {
                                cell24 = $('<td width=cellWidth + "%" align="center" style="height:10%"></td>').html('<label style="font-family:Arial">' + names[i + 1] + '</label>');
                                row24.append(cell24);
                            }
                        }
                        else if (j == 4) {
                            for (var i = 0; i < numOfCandidates; i++) {
                                cell25 = $('<td width=cellWidth + "%" align="center" style="height:10%"></td>').html('<label id=voted' + i + ' style="font-family:Arial">number of votes: ' + votedBy[i+1] + '</label>');
                                row25.append(cell25);
                            }
                        }
                    }
                    table2.append(row21);
                    table2.append(row22);
                    table2.append(row23);
                    table2.append(row24);
                    table2.append(row25);

                    $('#tableContainer').append(table2);
                    if (turn == 1) {
                        imageClick = true;
                        $('#waitImg').hide();
                        $('#turnStatus').text('Its your turn');
                        $('#voteStatus').text('VOTE NOW!');
                        progressBarFunc();
                    }
                    else {
                        imageClick = false;
                        $('#turnStatus').text('Please wait for your turn');
                        $('#voteStatus').text('');
                        $('#waitImg').show();
                    }
                });
            }; //details function

            main.client.yourTurn = function () {
                imageClick = true;
                $('#waitImg').hide();
                $('#turnStatus').text('Its your turn');
                $('#voteStatus').text('VOTE NOW!');
                $(".images").fadeTo("fast", 1);
                progressBarFunc();
            };

            main.client.votedUpdate = function (numOfCandidates, voted, votesL, turnsL, candIndex, defaultCand) {
                defaultVote = defaultCand;
                $('#votesLeft').text('Remaining votes: ' + votesL);
                $('#turnsLeft').text('Game terminates in: ' + turnsL);
                var votedBy = voted.split("#");
                for (var i = 0; i < numOfCandidates; i++) {
                    $('#voted' + i).text('number of votes: ' + votedBy[i+1]);
                }
                
                var candIndexes = candIndex.split('#');
                for (var i = 0; i < numOfCandidates; i++) {
                    if (i == defaultCand) {
                        var url = "/images/user" + (candIndexes[i + 1]) + "_default.png";
                        $('#'+i).attr('src', url);
                    }
                    else {
                        var url = "/images/user" + (candIndexes[i + 1]) + ".png";
                        $('#'+i).attr('src', url);
                    }
                } 
            }

            main.client.otherVotedUpdate = function (numOfCandidates, voted, votesL, turnsL) {
                $('#votesLeft').text('Remaining votes: ' + votesL);
                $('#turnsLeft').text('Game terminates in: ' + turnsL);
                var votedBy = voted.split("#");
                for (var i = 0; i < numOfCandidates; i++) {
                    $('#voted' + i).text('number of votes: ' + votedBy[i + 1]);
                }
            }

            main.client.gameOver = function (numOfCandidates, voted, votesL, turnsL, points, winner) {

                $('#votesLeft').text('Remaining votes: ' + votesL);
                $('#turnsLeft').text('Game terminates in: ' + turnsL);
                var votedBy = voted.split("#");
                for (var i = 0; i < numOfCandidates; i++) {
                    $('#voted' + i).text('number of votes: ' + votedBy[i+1]);
                }

                var pPoints = points.split('#');
                $('#waitImg').hide();
                $('#turnStatus').text('GAME OVER!!!');
                $('#gameOverTxt').html('The winning candidate is ' + winner + '<br><br> Player ' + (playerIndex + 1) + ', your score is: ' + pPoints[playerIndex + 1]);

            }
        });
    </script>
</body>
</html>



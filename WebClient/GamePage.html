<!DOCTYPE html>
<html>
<head>
    <title>Voting Game</title>
</head>
<body>
    <div id="MainPage">
          <input id="StartGame" type="button" value="Press To Start The Game" /><br>
         <label id="status"></label>
    </div>
    <div id="tableContainer" style="height: 90%"></div><br><br>
    <label id="test"></label>
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">
    <!--Reference the jQuery library. -->
    <link href="StyleGame.css" rel="stylesheet" />
    <script src="Scripts/jquery-2.1.0.min.js"></script>
    <script src="Scripts/jquery-ui-1.10.4.min.js"></script>
    <!--Reference the SignalR library. -->
    <script src="Scripts/jquery.signalR-2.0.2.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="http://localhost:8010/signalr/hubs"></script>
    <script>
        function progressBarFunc() {
            $('#secbar').progressbar({ value: '101.667' });
            $('#secbar').show();
            //  $('#secs').css('display', 'block').text("60");
            var sec = 61;
            var val = 101.667;
            barInterval = setInterval(function () {
                val = val - 1.667;
                sec--;
                $('#secbar').progressbar({
                    value: val,
                    change: function () {
                        $('#secs').css('display', 'block').text(sec);
                    },
                    complete: function () { }
                });
                if (sec == 0) {
                    $('#' + defaultVote).trigger('click');
                }

            }, 1000);
        };
    </script>
    <script>
        var barInterval;
        var numOfImages;
        var playerIndex;
        var defaultVote = 0;
        var imageClick = false;
        var main;
        var votesProgressInterval = 0;
        var showWhoVoted = false;
        $(function () {
            //Set the hubs URL for the connection
            $.connection.hub.url = "http://localhost:8010/signalr";

            // Declare a proxy to reference the hub.
            main = $.connection.serverHub;

            main.client.startGameMsg = function (msg) {
                if (msg == "wait")
                    $('#status').text("Please wait for the other players, the game will start shortly...");
                else if (msg == "start") {
                    $("#MainPage").hide();
                    main.server.gameDetailsMsg($.connection.hub.id);
                    //window.open("/GamePage.html", "_self", false);
                        $('#turnStatus').text('Please wait for your turn');
                }
            };
            
            main.client.gameDetails = function (msg, playerI, numOfCandidates, numPlayers, numVotes, numTurns, priority, candNames, candIndex, defaultCand, point, votes, isVoted, voted, turn, voting, winner) {
                //$('playerTurn').val(turn);
                votesProgressInterval = 190 / numOfCandidates;
                numOfImages = numOfCandidates;
                playerIndex = playerI;
                showWhoVoted = isVoted;

                //create table
                $(function () {
                    //first table
                    var table1 = $('<table border="0" width="100%" style="height:50%"></table>');
                    row11 = $('<tr border="0" width="100%" style="height:100%"></tr>');
                    cell11 = $('<td width="20%" align="left" valign="top" style="height:100%"></td>').html('<label style="font-family:Arial"> There are ' + numPlayers + ' players</label> <br/> <br/> <label id="votesLeft" style="font-family:Arial">Remaining votes: ' + numVotes + '</label> <br/><br/> <label id="turnsLeft" style="font-family:Arial"> Game terminates in: ' + numTurns + ' turns</label>');
                    cell12 = $('<td width="60%" align="center" style="height:100%"></td>').html('<label id="turnStatus" style="font-family:Arial" ></label><br><br><label id="voteStatus" style="font-family:Arial font:bold" ></label><img id="waitImg" src="/images/wait.gif" style="height:15%"><br><br><label id="playerVoted" style="font-family:Arial" ></label> <label id="gameOverTxt" style="font-family:Arial" ></label><br><br><div id="secbar"><div id="secs"></div></div>');
                    //cell13 = $('<td width="20%" align="left" valign="top" style="height:100%"></td>').html('<label id="votesLeft" style="font-family:Arial">Remaining votes: ' + numVotes + '</label> <br/> <label id="turnsLeft" style="font-family:Arial"> Game terminates in: ' + numTurns + ' turns</label>');
                    cell13 = $('<td width="20%" align="left" valign="top" style="height:100%"></td>').html('<label></label>');
                    table1.append(row11);
                    row11.append(cell11);
                    row11.append(cell12);
                    row11.append(cell13);
                    $('#tableContainer').append(table1);

                    //second table
                    var table2 = $('<table border="0" width="100%" style="height:50%" ></table>');
                    row21 = $('<tr border="0" width="100%" style="height:10%"></tr>'); //priority
                    row22 = $('<tr border="0" width="100%" style="height:10%"></tr>'); //points
                    row23 = $('<tr border="0" width="100%" style="height:60%"></tr>'); //pic
                    row24 = $('<tr border="0" width="100%" style="height:10%"></tr>'); //name
                    row25 = $('<tr border="0" width="100%" style="height:10%"></tr>'); //voted by
                    var cellWidth = 100 / numOfCandidates;
                    var points = point.split('#');
                    var priorities = priority.split('#');
                    var numOfVotes = votes.split('#');
                    var names = candNames.split('#');
                    var candIndexes = candIndex.split('#');
                    var whoVoted = voted.split("#");
                    for (var j = 0; j < 5; j++) { //for each row
                        if (j == 0) {
                            for (var i = 0; i < numOfCandidates; i++) {
                                cell21 = $('<td width=cellWidth + "%" align="center" style="height:10%"></td>').html('<label style="font-family:Arial">' + priorities[i] + '</label>');
                                row21.append(cell21);
                            }
                        }
                        else if (j == 1) {
                            for (var i = 0; i < numOfCandidates; i++) {
                                cell22 = $('<td width=cellWidth + "%" align="center" style="height:10%"></td>').html('<label style="font-family:Arial">' + points[i + 1] + ' points</label> <br><br>');
                                row22.append(cell22);
                            }
                        }
                        else if (j == 2) {
                            for (var i = 0; i < numOfCandidates; i++) {
                                if (i == 0)
                                    var url = "/images/user" + (candIndexes[i + 1]) + "_default.png";
                                else
                                    var url = "/images/user" + (candIndexes[i + 1]) + ".png";
                                var size = 80 - (8 * i);
                                cell23 = $('<td class="imgCells" width=cellWidth + "%" align="center" style="height:60%"></td>').
                                    html('<div class="progress"><label class="progNum" id="num' + i + '">' + numOfVotes[i + 1] + '</label><br /><div class="outer"> <div class="inner" id="inner'+i+'"></div></div></div> <img class="images" id="' + i + '" src="' + url + '" style="height:' + size + '%">');
                                row23.append(cell23);
                            }
                        }
                        else if (j == 3) {
                            for (var i = 0; i < numOfCandidates; i++) {
                                cell24 = $('<td width=cellWidth + "%" align="center" style="height:10%"></td>').html('<label style="font-family:Arial">' + names[i + 1] + '</label>');
                                row24.append(cell24);
                            }
                        }
                        else if (showWhoVoted == true && j == 4) {
                            for (var i = 0; i < numOfCandidates; i++) {
                                cell25 = $('<td width=cellWidth + "%" align="center" style="height:10%"></td>').html('<label id=voted' + i + ' style="font-family:Arial">Who voted: ' + whoVoted[i + 1] + '</label>');
                                row25.append(cell25);
                            }
                        }
                    }
                    table2.append(row21);
                    table2.append(row22);
                    table2.append(row23);
                    table2.append(row24);
                    table2.append(row25);

                    $('#tableContainer').append(table2);

                    var winners = winner.split("#");
                    var red = 0;
                    for (var i = 0; i < numOfCandidates; i++) {
                        red = 0;
                        for (var j = 1; j < winners.length; j++) {
                            if (winners[j] == i) {
                                $('#inner' + winners[j]).css('background-image', 'url("/images/progressBar2Red.png")');
                                red = 1;
                            }
                        }
                        if (red == 0)
                            $('#inner' + i).css('background-image', 'url("/images/progressBar2.png")');
                    }

                    for (var i = 0; i < numOfCandidates; i++) {
                        $('#inner'+i).animate({
                            height: (numOfVotes[i + 1] * votesProgressInterval)
                        }, 250);
                        $('#num' + i).text(numOfVotes[i + 1]);
                    }

                    if (turn == 1) {
                        imageClick = true;
                        $('#waitImg').hide();
                        $('#playerVoted').text('');
                        $('#turnStatus').text("It's your turn");
                        $('#voteStatus').text('VOTE NOW!');
                        progressBarFunc();
                    }
                    else {
                        imageClick = false;
                        $('#turnStatus').text('Please wait for player ' + (voting+1) + ' to vote');
                        $('#voteStatus').text('');
                        $('#waitImg').show();
                    }
                });
            }; //details function

            main.client.yourTurn = function () {
                imageClick = true;
                $('#waitImg').hide();
                $('#playerVoted').text('');
                $('#turnStatus').text("It's your turn");
                $('#voteStatus').text('VOTE NOW!');
                $(".images").fadeTo("fast", 1);
                progressBarFunc();
            };

            main.client.votedUpdate = function (numOfCandidates, votes, votesL, turnsL, candIndex, defaultCand, playerV, voting, winner, whoVoted) {
                defaultVote = defaultCand;
                $('#playerVoted').text('player ' + (playerV + 1) + ' voted');
                $('#turnStatus').text('Please wait for player ' + (voting+1) + ' to vote');
                $('#votesLeft').text('Remaining votes: ' + votesL);
                $('#turnsLeft').text('Game terminates in: ' + turnsL);
                var numOfVotes = votes.split("#");
                var winners = winner.split("#");
                if (showWhoVoted == true) {
                    var whoVotedString = whoVoted.split("#");
                    for (var i = 0; i < numOfCandidates; i++) {
                        $('#voted' + i).text('Who voted: ' + whoVotedString[i + 1]);
                    }
                }


                var red = 0;
                for (var i = 0; i < numOfCandidates; i++) {
                    red = 0;
                    for (var j = 1; j < winners.length; j++) {
                        if (winners[j] == i) {
                            $('#inner' + winners[j]).css('background-image', 'url("/images/progressBar2Red.png")');
                            red = 1;
                        }
                    }
                    if (red == 0)
                        $('#inner' + i).css('background-image', 'url("/images/progressBar2.png")');
                }

                for (var i = 0; i < numOfCandidates; i++) {
                    $('#inner' + i).animate({
                        height: (numOfVotes[i + 1] * votesProgressInterval)
                    }, 250);
                    $('#num' + i).text(numOfVotes[i + 1]);
                }


                var candIndexes = candIndex.split('#');
                for (var i = 0; i < numOfCandidates; i++) {
                    if (i == defaultCand) {
                        var url = "/images/user" + (candIndexes[i + 1]) + "_default.png";
                        $('#' + i).attr('src', url);
                    } else {
                        var url = "/images/user" + (candIndexes[i + 1]) + ".png";
                        $('#' + i).attr('src', url);
                    }
                }
            };

            main.client.otherVotedUpdate = function (numOfCandidates, votes, votesL, turnsL, playerV, voting, winner, whoVoted) {
                $('#turnStatus').text('Please wait for player ' + (voting+1) + ' to vote');
                $('#votesLeft').text('Remaining votes: ' + votesL);
                $('#turnsLeft').text('Game terminates in: ' + turnsL);
                var numOfVotes = votes.split("#");
                var winners = winner.split("#");
                if (showWhoVoted == true) {
                    var whoVotedString = whoVoted.split("#");
                    for (var i = 0; i < numOfCandidates; i++) {
                        $('#voted' + i).text('Who voted: ' + whoVotedString[i + 1]);
                    }
                }
                var red = 0;
                for (var i = 0; i < numOfCandidates; i++) {
                    red = 0;
                    for (var j = 1; j < winners.length; j++) {
                        if (winners[j] == i) {
                            $('#inner' + winners[j]).css('background-image', 'url("/images/progressBar2Red.png")');
                            red = 1;
                        }
                    }
                    if(red == 0)
                        $('#inner' + i).css('background-image', 'url("/images/progressBar2.png")');
                }
                for (var i = 0; i < numOfCandidates; i++) {
                    $('#inner' + i).animate({
                        height: (numOfVotes[i + 1] * votesProgressInterval)
                    }, 250);
                    $('#num' + i).text(numOfVotes[i + 1]);
                }

                $('#playerVoted').text('player ' + (playerV+1) + ' voted');

            };

            main.client.gameOver = function (numOfCandidates, votes, votesL, turnsL, points, winner, currentWinner, whoVoted) {

                imageClick = false;
                $('#votesLeft').text('Remaining votes: ' + votesL);
                $('#turnsLeft').text('Game terminates in: ' + turnsL);
                var numOfVotes = votes.split("#");
                var winners = currentWinner.split("#");
                if (showWhoVoted == true) {
                    var whoVotedString = whoVoted.split("#");
                    for (var i = 0; i < numOfCandidates; i++) {
                        $('#voted' + i).text('Who voted: ' + whoVotedString[i + 1]);
                    }
                }
                var red = 0;
                for (var i = 0; i < numOfCandidates; i++) {
                    red = 0;
                    for (var j = 1; j < winners.length; j++) {
                        if (winners[j] == i) {
                            $('#inner' + winners[j]).css('background-image', 'url("/images/progressBar2Red.png")');
                            red = 1;
                        }
                    }
                    if (red == 0)
                        $('#inner' + i).css('background-image', 'url("/images/progressBar2.png")');
                }
                for (var i = 0; i < numOfCandidates; i++) {
                    $('#inner' + i).animate({
                        height: (numOfVotes[i + 1] * votesProgressInterval)
                    }, 250);
                    $('#num' + i).text(numOfVotes[i + 1]);
                }


                var pPoints = points.split('#');
                $('#waitImg').hide();
                $('#playerVoted').text('');
                $('#turnStatus').text('GAME OVER!!!');
                $('#gameOverTxt').html('The winning candidate is ' + winner + '<br/> Your score is: ' + pPoints[playerIndex + 1]);

            };
            
            $.connection.hub.start().done(function () {
                $('#StartGame').click(function () {
                    // Call the Send method on the hub.
                    main.server.connectMsg('connect', $.connection.hub.id);
                });
            });
        });
        
        $(document).on('click', '.images', function (event) {
            if (imageClick) {
                $(".images:not(#" + event.target.id + ")").fadeTo("fast", 0.5);
                $("#" + event.target.id).fadeTo("fast", 1);

                clearInterval(barInterval);
                $('#secbar').hide();
                $('#turnStatus').text('Please wait for your turn');
                $('#waitImg').show();
                $('#voteStatus').text('');
                imageClick = false;

                main.server.voteDetails($.connection.hub.id, playerIndex, event.target.id);
            }

        });

       
        
    </script>
</body>
</html>

